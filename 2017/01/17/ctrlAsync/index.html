<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> angualr动态加载controller问题 · Mark</title><meta name="description" content="angualr动态加载controller问题 - Mark"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/mark.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Mark"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/markh5" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">angualr动态加载controller问题</h1><div class="post-info">2017年1月17日</div><div class="post-content"><p>在重构前端项目的过程中，需要根据主模块动态加载控制器，但<strong>angular要求在开启服务前必须将所有控制器、服务、依赖的模块全部加载完成</strong>，下面详细说一下解决方案。</p>
<p>目录结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">main/</div><div class="line">	controllers/ </div><div class="line">	view/</div><div class="line">	index.html</div><div class="line">	app.js</div><div class="line">	main.js</div><div class="line">libs/</div></pre></td></tr></table></figure>
<p>首先</p>
<p>index.html：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;div ng-view&gt;&lt;/div&gt;</div><div class="line">&lt;script data-main=&quot;main.js&quot; src=&quot;libs/require.js&quot;&gt;</div></pre></td></tr></table></figure></p>
<p>在main.js中配置require需要加载的内容：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">requirejs.config(&#123;</div><div class="line">   paths: &#123;</div><div class="line">       jQuery: <span class="string">'../libs/jquery.min'</span>,</div><div class="line">       angular: <span class="string">'..libs/angular.min'</span>,</div><div class="line">       angularRouter: <span class="string">'../libs/angular-route.min'</span>,</div><div class="line">       angularAnimate: <span class="string">'../libs/angular-animate.min'</span></div><div class="line">   &#125;,</div><div class="line">   shim: &#123;</div><div class="line">       <span class="string">'angular'</span>: &#123;</div><div class="line">           deps: [<span class="string">'jQuery'</span>],</div><div class="line">           exports: <span class="string">'angular'</span></div><div class="line">       &#125;,</div><div class="line">       angularRouter: &#123;</div><div class="line">           deps: [<span class="string">'angular'</span>],</div><div class="line">           exports: <span class="string">'ngRoute'</span></div><div class="line">       &#125;,</div><div class="line">       angularAnimate: &#123;</div><div class="line">           deps: [<span class="string">'angular'</span>]</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 手动开启angular服务</span></div><div class="line"><span class="built_in">require</span>([<span class="string">'angular'</span>, <span class="string">'app'</span>], <span class="function"><span class="keyword">function</span>(<span class="params">angular</span>)</span>&#123;</div><div class="line">   angular.element(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">       angular.bootstrap(<span class="built_in">document</span>, [<span class="string">'yceMain'</span>]);</div><div class="line">   &#125;);</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>angular.bootstrap是手动开启ng服务的选项，就不需要在html代码中加入ng-app指令开启了。</p>
<p>app.js：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">	</div><div class="line">(define[<span class="string">'angular'</span>, <span class="string">'angularRouter'</span>], <span class="function"><span class="keyword">function</span>(<span class="params">angular</span>)</span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> yceMain = angular.module(<span class="string">'yceMain'</span>, [<span class="string">'ngRoute'</span>]);</div><div class="line">	</div><div class="line">	yceMain.config([<span class="string">'$routeProvider'</span>, <span class="string">'$controllerProvider'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$routeProvider, $controllerProvider</span>)</span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">var</span> ctrlRegister = <span class="function"><span class="keyword">function</span>(<span class="params">ctrlName, ctrlModule</span>) </span>&#123;</div><div class="line">			<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">$q</span>) </span>&#123;</div><div class="line">				<span class="keyword">var</span> defer = $q.defer();</div><div class="line">				<span class="built_in">require</span>(ctrlModule, <span class="function"><span class="keyword">function</span> (<span class="params">controller</span>) </span>&#123;</div><div class="line">					$controllerProvider.register(ctrlName, controller);</div><div class="line">					defer.resolve();</div><div class="line">				&#125;);</div><div class="line">				<span class="keyword">return</span> defer.promise;</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line"></div><div class="line">		$routeProvider</div><div class="line">            .when(<span class="string">'/dashBoard'</span>, &#123;</div><div class="line">                templateUrl: <span class="string">'views/dashBoard.html'</span>,</div><div class="line">                controller: <span class="string">'dashBoardCtrl'</span>,</div><div class="line">                resolve: &#123;</div><div class="line">                    delay: ctrlRegister(<span class="string">'dashBoardCtrl'</span>,[<span class="string">'controllers/dashBoard.js'</span>])</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">            .when(<span class="string">'/appManage'</span>, &#123;</div><div class="line">                templateUrl: <span class="string">'views/appManage.html'</span>,</div><div class="line">                controller: <span class="string">'appManageCtrl'</span>,</div><div class="line">                resolve: &#123;</div><div class="line">                    delay: ctrlRegister(<span class="string">'appManageCtrl'</span>,[<span class="string">'controllers/appManage.js'</span>])</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line"></div><div class="line">	&#125;);</div><div class="line">	<span class="keyword">return</span> yceMain;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>使用ngRoute提供的routeProvider服务进行路由配置，其中resolve是做什么的呢？</p>
<ul>
<li>在页面跳转时，只有当resolve对象中所有的参数都执行resolve()方法后，才会进行页面渲染、实例控制器等操作。</li>
<li>resolve对象中的参数名称都是由自己定义的，这时会发生一件事情，在实例控制器时，参数名会注入到对应的控制器中。</li>
<li>resolve一般用来预加载的工作。</li>
</ul>
<p>下面详细说一下ctrlRegister函数的作用：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ctrlRegister = <span class="function"><span class="keyword">function</span>(<span class="params">ctrlName, ctrlModule</span>) </span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">$q</span>) </span>&#123;</div><div class="line">		<span class="comment">//实例一个promise对象</span></div><div class="line">		<span class="keyword">var</span> defer = $q.defer();</div><div class="line">		<span class="comment">//angular不仅可以通过module去注册控制器</span></div><div class="line">		<span class="comment">//还可以使用$controllerProvider去注册控制器，如下</span></div><div class="line">		<span class="built_in">require</span>(ctrlModule, <span class="function"><span class="keyword">function</span> (<span class="params">controller</span>) </span>&#123;</div><div class="line">			$controllerProvider.register(ctrlName, controller);</div><div class="line">			<span class="comment">//注册成功后，执行defer.resolve()，表示完成一个promise任务</span></div><div class="line">			<span class="comment">//这个返回值自动赋给defer.promise</span></div><div class="line">			defer.resolve();</div><div class="line">		&#125;);</div><div class="line">        <span class="comment">// 每个promise在创建并执行后，必须给调用它的函数返回promise</span></div><div class="line">		<span class="keyword">return</span> defer.promise;</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>angular将promise封装在了\$q中，$q是angular的一种内置服务，它可以使你异步地执行函数，并且当函数执行完成时它允许你使用函数的返回值（或异常）。</p>
<p>关于promise文档，<a href="http://www.tuicool.com/articles/FfaA7bu" target="_blank" rel="external">请看这里</a>。</p>
<p>接下来的事情就比较简单了，在需要加载的controller(dashBoard.js)中这样写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">define(function()&#123;</div><div class="line">	return function dashBoardCtrl($scope, $http)&#123;</div><div class="line">		// xxx	</div><div class="line">	&#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>这样搭建项目的好处是当点击#/dashBoardsh时，只会加载dashBoard对应的html和controller，节省带宽。</p>
</div></article></div></section><footer><div class="paginator"></div><div class="copyright"><p>© Mark :) , powered by <a href="https://hexo.io/" target="_blank">Hexo</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>